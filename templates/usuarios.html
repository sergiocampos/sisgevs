{% extends 'base1.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static '_esporotricose_humana/css/registros.css' %}">
<script src="{% static 'base/js/usuarios.js' %}" defer></script>

<link rel="stylesheet" href="{% static 'base/css/virtual-select.min.css' %}" />
<style>
    .vscomp-clear-button{display: none !important;}
    .vscomp-option-text {overflow: visible !important;}
</style>
{% endblock head %}

{% block content %}
<div class="mt-3">
    <div class="alert alert-primary text-center">
        <h1 class="fs-2">Usuários</h1>
    </div>
    <div class="row">
        <div class="col">
            <input class="form-control" type="text" id="pesquisar-registros" placeholder="Pesquisar...">
        </div>        
    </div>
    
    {% include 'messages/message.html' %}
    <input type="hidden" id="req_user_agravos" value="{{user.lista_agravos_permite}}">
    <div class="mt-3">
        <table class="table table-bordered">
            <thead>
                <th scope="col">NOME</th>
                <th scope="col">TELEFONE</th>
                <th scope="col">MUNICIPIO</th>
                <th scope="col">AGRAVOS (** Solicitação)</th>
                <th scope="col">FUNÇÃO</th>
                <th scope="col" class="d-none unidade-hospitalar">Unidade Hospitalar</th>
            </thead>
            <tbody id="table-registros">
                {% for usuario in usuarios %}
                <tr class="align-middle">
                    <td>{{usuario.username}}</td>
                    <td>{{usuario.telefone}}</td>
                    <td>{{usuario.municipio}}</td>                        
                    <td>
                        {% if usuario.esp_hum_solicit or usuario.aci_solicit %}
                        <select class="agravos-select" id="{{usuario.id}}" multiple name="native-select" placeholder="** Selecione os Agravos" data-search="true" data-silent-initial-value-set="true">
                        {% else %}
                        <select class="agravos-select" id="{{usuario.id}}" multiple name="native-select" placeholder="Selecione os Agravos" data-search="true" data-silent-initial-value-set="true">
                        {% endif %}

                        {% for agravo in request.user.lista_agravos_permite %}        
                        {% if agravo == 'esp-hum' %}
                        
                            {% if usuario.esp_hum %}
                            <option value="esp-hum" selected>Esporotricose Humana</option>
                            {% else %}
                            <option value="esp-hum">
                                {% if usuario.esp_hum_solicit %}
                                <strong style="color: red !important">**</strong>
                                {% endif %} 
                                Esporotricose Humana
                            </option>
                            {% endif %}
                            
                        {% elif agravo == 'aci' %}
                            
                            {% if usuario.aci %}
                            <option value="aci" selected>Acidentes de Trânsito</option>
                            {% else %}
                            <option value="aci">
                                {% if usuario.aci_solicit %}
                                <strong style="color: red !important">**</strong>
                                {% endif %}
                                Acidentes de Trânsito
                            </option>                                                           
                            {% endif %} 
                            
                        {% endif %}
                        {% endfor %}
                        </select>    
                    </td>                 
                    <td>
                        <select class="funcoes-select w-100" id="{{usuario.id}}" name="native-select" placeholder="Selecione a Função" data-search="true" data-silent-initial-value-set="true">                        
                        {% for funcao in funcoes %}                        
                        {% if user.lista_agravos_permite %}
                            {% if funcao.value == usuario.funcao %}
                            <option value="{{funcao.value}}" selected>{{funcao.name}}</option>
                            {% else %}
                            <option value="{{funcao.value}}">{{funcao.name}}</option>
                            {% endif %}
                        {% else %}
                            {% if funcao.value == usuario.funcao %}
                            <option value="{{funcao.value}}" selected>{{funcao.name}}</option>
                            {% endif %}                        
                        {% endif %}
                        {% endfor %}
                        </select>                        
                    </td>
                    {% if usuario.funcao == 'coordenacao_vigilancia_epidemiologica_hospitalar' %}
                    <td>
                        <select class="hospital-select" id="{{usuario.id}}" name="native-select" placeholder="Selecione a Unidade" data-search="true" data-silent-initial-value-set="true">
                            <option value="" selected disabled>Selecione</option>
                            <option value="desabilitado">Desabilitar</option>
                            {% for hosp in usuario.hosp_list %}
                                {% if usuario.unidade_saude == hosp.nome %}
                                <option value="{{hosp.nome}}" selected>{{hosp.nome}}</option>
                                {% else %}
                                <option value="{{hosp.nome}}">{{hosp.nome}}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    </div>    
</div>
{% endblock content %}

{% block endbody %}
<script src="{% static 'base/js/virtual-select.min.js' %}"></script>
<script>

    $(window).ready( 
        document.getElementsByClassName('hospital-select').length 
            ? $('.unidade-hospitalar').removeClass('d-none') 
            : $('.unidade-hospitalar').addClass('d-none')
    )
    // Select de agravos
    VirtualSelect.init({
        ele: '.agravos-select',
        searchPlaceholderText: "Procurar",
        noSearchResultsText: "Nenhum item encontrado",
        allOptionsSelectedText: "Todos os itens selecionados"
    });
    // Select de funções
    VirtualSelect.init({
        ele: '.funcoes-select',
        searchPlaceholderText: "Procurar",
        noSearchResultsText: "Nenhum item encontrado",
        allOptionsSelectedText: "Todos os itens selecionados"
    });        
    // Select da unidade hospitalar
    VirtualSelect.init({
        ele: '.hospital-select',
        searchPlaceholderText: "Procurar",
        noSearchResultsText: "Nenhum item encontrado",
        allOptionsSelectedText: "Todos os itens selecionados"
    });        
</script>
{% endblock endbody %}